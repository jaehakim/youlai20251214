<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youlai.boot.system.mapper.LogMapper">

    <!-- 로그 페이지 목록 (기본/Oracle용) -->
    <select id="getLogPage" resultType="com.youlai.boot.system.model.vo.LogPageVO">
        SELECT
            t1.id,
            t1.module,
            t1.content,
            t1.request_uri,
            t1.ip,
            t1.province || ' ' || t1.city AS region,
            t1.execution_time,
            t1.browser || ' ' || t1.browser_version AS browser,
            t1.os,
            t1.create_time,
            t2.nickname AS operator
        FROM
            sys_log t1
            LEFT JOIN sys_user t2 ON t1.create_by = t2.id
        <where>
            t1.is_deleted = 0
            <if test="queryParams.keywords != null and queryParams.keywords != ''">
                AND (
                    t1.content LIKE '%' || #{queryParams.keywords} || '%'
                    OR
                    t1.ip LIKE '%' || #{queryParams.keywords} || '%'
                    OR
                    t2.nickname LIKE '%' || #{queryParams.keywords} || '%'
                )
            </if>
            <if test="queryParams.createTime != null and queryParams.createTime.size > 0">
                <if test="queryParams.createTime[0] != null and queryParams.createTime[0] != ''">
                    AND TRUNC(t1.create_time) &gt;= TO_DATE(SUBSTR(#{queryParams.createTime[0]}, 1, 10), 'YYYY-MM-DD')
                </if>
                <if test="queryParams.createTime[1] != null and queryParams.createTime[1] != ''">
                    AND TRUNC(t1.create_time) &lt;= TO_DATE(SUBSTR(#{queryParams.createTime[1]}, 1, 10), 'YYYY-MM-DD')
                </if>
            </if>
        </where>
        <!-- 동적 정렬: 프론트엔드에서 지정한 정렬 필드와 방향으로 정렬 -->
        <choose>
            <when test="queryParams.hasSortCondition() and queryParams.isValidSortField(queryParams.sortBy)">
                <!-- create_time -->
                <if test="'create_time'.equals(queryParams.sortBy)">
                    ORDER BY t1.create_time <choose><when test="'asc'.equalsIgnoreCase(queryParams.sortDirection)">ASC</when><otherwise>DESC</otherwise></choose>
                </if>
                <!-- execution_time -->
                <if test="'execution_time'.equals(queryParams.sortBy)">
                    ORDER BY t1.execution_time <choose><when test="'asc'.equalsIgnoreCase(queryParams.sortDirection)">ASC</when><otherwise>DESC</otherwise></choose>
                </if>
                <!-- create_by -->
                <if test="'create_by'.equals(queryParams.sortBy)">
                    ORDER BY t1.create_by <choose><when test="'asc'.equalsIgnoreCase(queryParams.sortDirection)">ASC</when><otherwise>DESC</otherwise></choose>
                </if>
            </when>
            <otherwise>
                <!-- 기본 정렬: 작업 시간 내림차순 -->
                ORDER BY t1.create_time DESC
            </otherwise>
        </choose>
    </select>


    <!-- 방문량 일별 통계 목록 조회 (기본/Oracle용) -->
    <select id="getPvCounts" resultType="com.youlai.boot.system.model.bo.VisitCount">
        SELECT
            COUNT(1) AS count,
            TO_CHAR(create_time, 'YYYY-MM-DD') AS createDate
        FROM
            sys_log
        WHERE
            TRUNC(create_time) BETWEEN TO_DATE(SUBSTR(#{startDate}, 1, 10), 'YYYY-MM-DD') AND TO_DATE(SUBSTR(#{endDate}, 1, 10), 'YYYY-MM-DD')
          AND is_deleted = 0
        GROUP BY
            TO_CHAR(create_time, 'YYYY-MM-DD')
        ORDER BY
            createDate ASC
    </select>

    <!-- 방문량 일별 통계 목록 조회 (MySQL용) -->
    <select id="getPvCounts" resultType="com.youlai.boot.system.model.bo.VisitCount" databaseId="mysql">
        SELECT
            COUNT(1) AS count,
            DATE_FORMAT(create_time, '%Y-%m-%d') AS createDate
        FROM
            sys_log
        WHERE
            DATE(create_time) BETWEEN DATE(#{startDate}) AND DATE(#{endDate})
          AND is_deleted = 0
        GROUP BY
            DATE_FORMAT(create_time, '%Y-%m-%d')
        ORDER BY
            createDate ASC
    </select>


    <!-- IP 일별 통계 목록 조회 (기본/Oracle용) -->
    <select id="getIpCounts" resultType="com.youlai.boot.system.model.bo.VisitCount">
        SELECT
            COUNT(DISTINCT ip) AS count,
            TO_CHAR(create_time, 'YYYY-MM-DD') AS createDate
        FROM
            sys_log
        WHERE
            TRUNC(create_time) BETWEEN TO_DATE(SUBSTR(#{startDate}, 1, 10), 'YYYY-MM-DD') AND TO_DATE(SUBSTR(#{endDate}, 1, 10), 'YYYY-MM-DD')
          AND is_deleted = 0
        GROUP BY
            TO_CHAR(create_time, 'YYYY-MM-DD')
        ORDER BY
            createDate ASC
    </select>

    <!-- IP 일별 통계 목록 조회 (MySQL용) -->
    <select id="getIpCounts" resultType="com.youlai.boot.system.model.bo.VisitCount" databaseId="mysql">
        SELECT
            COUNT(DISTINCT ip) AS count,
            DATE_FORMAT(create_time, '%Y-%m-%d') AS createDate
        FROM
            sys_log
        WHERE
            DATE(create_time) BETWEEN DATE(#{startDate}) AND DATE(#{endDate})
          AND is_deleted = 0
        GROUP BY
            DATE_FORMAT(create_time, '%Y-%m-%d')
        ORDER BY
            createDate ASC
    </select>


    <!-- 방문량(PV) 통계 데이터 조회 (기본/Oracle용) -->
    <select id="getPvStats" resultType="com.youlai.boot.system.model.bo.VisitStatsBO">
        SELECT
            COUNT(CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) THEN 1 END) AS todayCount,
            COUNT(*) AS totalCount,
            ROUND(
                CASE
                    WHEN COUNT(CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN 1 END) = 0 THEN 0
                ELSE
                    (COUNT(CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) THEN 1 END) -
                    COUNT(CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN 1 END)) /
                    COUNT(CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN 1 END)
                END,
            2) AS growthRate
        FROM
            sys_log
        WHERE
            is_deleted = 0
    </select>

    <!-- 방문량(PV) 통계 데이터 조회 (MySQL용) -->
    <select id="getPvStats" resultType="com.youlai.boot.system.model.bo.VisitStatsBO" databaseId="mysql">
        SELECT
            COUNT(CASE WHEN DATE(create_time) = CURDATE() THEN 1 END) AS todayCount,
            COUNT(*) AS totalCount,
            ROUND(
                CASE
                    WHEN COUNT(CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN 1 END) = 0 THEN 0
                ELSE
                    (COUNT(CASE WHEN DATE(create_time) = CURDATE() THEN 1 END) -
                    COUNT(CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN 1 END)) /
                    COUNT(CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN 1 END)
                END,
            2) AS growthRate
        FROM
            sys_log
        WHERE
            is_deleted = 0
    </select>


    <!-- IP 통계 데이터 조회 (기본/Oracle용) -->
    <select id="getUvStats" resultType="com.youlai.boot.system.model.bo.VisitStatsBO">
        SELECT
            COUNT(DISTINCT CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) THEN ip END) AS todayCount,
            COUNT(DISTINCT ip) AS totalCount,
            ROUND(
                CASE
                    WHEN COUNT(DISTINCT CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN ip END) = 0 THEN 0
                    ELSE
                        (COUNT(DISTINCT CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) THEN ip END) -
                         COUNT(DISTINCT CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN ip END)) /
                        COUNT(DISTINCT CASE WHEN TRUNC(create_time) = TRUNC(SYSDATE) - 1 AND create_time &lt;= SYSDATE THEN ip END)
                    END,
                2) AS growthRate
        FROM
            sys_log
        WHERE
            is_deleted = 0
    </select>

    <!-- IP 통계 데이터 조회 (MySQL용) -->
    <select id="getUvStats" resultType="com.youlai.boot.system.model.bo.VisitStatsBO" databaseId="mysql">
        SELECT
            COUNT(DISTINCT CASE WHEN DATE(create_time) = CURDATE() THEN ip END) AS todayCount,
            COUNT(DISTINCT ip) AS totalCount,
            ROUND(
                CASE
                    WHEN COUNT(DISTINCT CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN ip END) = 0 THEN 0
                    ELSE
                        (COUNT(DISTINCT CASE WHEN DATE(create_time) = CURDATE() THEN ip END) -
                         COUNT(DISTINCT CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN ip END)) /
                        COUNT(DISTINCT CASE WHEN DATE(create_time) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN ip END)
                    END,
                2) AS growthRate
        FROM
            sys_log
        WHERE
            is_deleted = 0
    </select>


</mapper>
